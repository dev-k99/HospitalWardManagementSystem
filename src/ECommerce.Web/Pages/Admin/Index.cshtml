@page
@model AdminIndexModel
@{
    ViewData["Title"] = "Admin Dashboard";
}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<div class="container mt-4">
  <h2>Admin Dashboard</h2>
  <div class="row g-4">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">Sales (last 30 days)</div>
        <div class="card-body"><canvas id="salesChart" height="120"></canvas></div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card mb-4">
        <div class="card-header">Active Users (10 min)</div>
        <div class="card-body display-6" id="activeUsers">0</div>
      </div>
      <div class="card">
        <div class="card-header">Top Pages</div>
        <ul class="list-group list-group-flush" id="topPages"></ul>
      </div>
    </div>
  </div>
  <div class="row g-4 mt-2">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header">Top Products</div>
        <div class="card-body">
          <table class="table" id="topProducts"></table>
        </div>
      </div>
    </div>
  </div>
</div>

@section Scripts{
<script>
(async function(){
  const token = localStorage.getItem('jwt');
  const headers = { 'Authorization': `Bearer ${token}` };

  const [salesRes, usersRes, pagesRes, productsRes] = await Promise.all([
    fetch('/api/admin/metrics/sales?days=30', { headers }),
    fetch('/api/admin/metrics/active-users?windowMinutes=10', { headers }),
    fetch('/api/admin/metrics/top-pages?days=7&limit=10', { headers }),
    fetch('/api/admin/metrics/top-products?limit=10', { headers })
  ]);
  if([salesRes, usersRes, pagesRes, productsRes].some(r => r.status === 401)){
    alert('Admin login required');
    return;
  }

  const sales = await salesRes.json();
  const users = await usersRes.json();
  const pages = await pagesRes.json();
  const products = await productsRes.json();

  // Sales chart
  const labels = sales.map(s => s.date);
  const totals = sales.map(s => s.total);
  new Chart(document.getElementById('salesChart'), {
    type: 'line', data: { labels, datasets: [{ label: 'Sales ($)', data: totals, borderColor: '#0d6efd', fill: false }]},
    options: { scales: { y: { beginAtZero: true }}}
  });

  // Active users
  document.getElementById('activeUsers').textContent = users.count;

  // Top pages
  const tp = document.getElementById('topPages');
  tp.innerHTML = pages.map(p => `<li class="list-group-item d-flex justify-content-between"><span>${p.path}</span><span>${p.hits}</span></li>`).join('');

  // Top products
  const table = document.getElementById('topProducts');
  table.innerHTML = '<thead><tr><th>Product</th><th>Qty</th></tr></thead>' + products.map(p => `<tr><td>${p.name}</td><td>${p.quantity}</td></tr>`).join('');
})();
</script>
}
